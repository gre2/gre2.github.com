---
layout: post
title: "系统业务架构演变"
description: ""
category: [java,实践]
tags: [实践]
---
{% include JB/setup %}

# 系统业务架构演变

#### 1.对外合作系统介绍=授权服务+会员产品买赠

```
1.负责非爱奇艺端的和爱奇艺端会员产品买赠的权益开通代理服务
2.模块划分：api(针对端开权益)；worker（监听订单完成消息，处理买赠，买退逻辑）
3.访问量：单台qps100,10台机器
4.拆分系统：对外授权系统 + 会员产品买赠系统
5.拆分原因：别的系统还有会员产品的买赠，会员内部业务逻辑整合；对外授权系统职责划分更明确，只是对外交互
6.业务特点：合作方账号和爱奇艺账号打通；
           开通权益的可靠性和及时性（同步，异步）
           同步：合作方自动重试，下游系统自动重试
           异步：指数次调用下游系统开权益
7.业务复杂点：复杂的买赠营销策略；
             自动赠送，自动退款策略，海量消息处理，如何match自己的处理引擎，如何扩展处理策略
8.业务痛点：每次多链路系统调用最底层系统出现异常，中间系统先写mongdb，2s后启动worker去写mysql，任务量
           大的时候，任务产生堆积，查询mysql找不到数据，重复创建权益订单，无法有效的根据第三方订单号保证
           幂等性，事后每次都要处理数据，主导下游系统更改,利用公司mysql组件，缩短主从同步时间
           
           任务工具打垮权益系统，不是分布式任务框架，任务量大的时候影响权益系统本身service的业务逻辑处
           理，可以对服务进行service和worker分组
```

#### 2.系统业务架构演变

```
1期.以前worker复杂的买赠逻辑，平铺直序，写在一个类里面，而且逻辑划分不明确，if，else无限多，难以维护，更
    换成策略+模板双模式，特殊逻辑采用插拔式，符合归一，开闭原则。
2期.首先以前worker处理订单完成消息采用amq，后来切换成rocketmq，抗堆积，易扩展，支持组消费，组和组互不影
    响。
3期.数据库买赠规则，订单，领取关系表字段不明确，没法有效的扩展，重构数据库
4期.worker层拆分成会员买赠系统，指定系统维度（会员身份）而非产品，产品变化太频繁
5期.worker层拆分成会员买赠系统，重新制定买赠规则，筛选规则（脚本语言表达式支持，动态扩展），执行规则
6期.模板+策略双模式，公共抽象类里面涉及数据库的业务查询，浪费时间，缓存数据到内存（定时任务），减少数据库
    io消耗
7期.条件筛选接入redis，key=条件表主键，value=条件筛选表达式
    任务执行规则接入redis，key=条件主键，field=规则表主键，value=具体规则
    redis一主二从，双机房
8期.api层拆分成对外授权服务系统，整合合作方多个数据表，去掉爱奇艺端直接调用系统，切换成端上调用买赠系统，
    系统职责划分更明确，数据库也拆分开了，授权服务关于爱奇艺端的数据依赖买赠系统的接口
```

#### 3.业务架构图

买赠：

![](https://ws1.sinaimg.cn/large/87a42753ly1fvgawtsin3j20nw08jwfv.jpg)

授权：

![](https://ws1.sinaimg.cn/large/87a42753ly1fvgaymwza1j20e80ed0tt.jpg)

#### 4.技术架构图

![](https://ws1.sinaimg.cn/large/87a42753ly1fvgaukfjekj20d80cljs0.jpg)


