---
layout: post
title: "（内存）java内存模型"
description: ""
category: [java,基础]
tags: [基础]
---
{% include JB/setup %}

# java内存模型

### CPU和缓存一致性

计算机在执行程序的时候，每条指令都在cpu中执行，而执行的时候，需要和计算机物理内存交互，但是随着cpu的迅猛发展，而内存技术没有太大的变化，所以内存中读取和写入数据的速度远远低于cpu的执行速度，所以想到了在cpu和内存中间加入**高速缓存**

![](http://ww1.sinaimg.cn/large/87a42753ly1g3gz8of8pcj20e908ygoy.jpg)**

1.单线程（串行）：cpu核心缓存只被一个线程访问

2.单核（单个领导人），多线程（并行）：不同线程在访问相同的物理地址的时候，会映射到相同的缓存位置，即使发生线程切换，缓存不会失效，任何时刻只有一个线程在执行，不会出现缓存访问冲突

3.多核（多个领导人），多线程（并行）：每核至少有一个L1缓存，每个线程访问某个共享内存，多个线程在不同的核心上执行，则每个核心都会在各自cache中保留一份共享内存的缓冲，因此存在缓存不一致的情况

### 解决缓存不一致

前面说的缓存不一致性问题，处理器优化的指令重排问题是硬件的不断升级导致的。为了解决这个问题，保证并发编程可以满足原子性，有序性，可见性，有一个重要的概念，那就是内存模型。

内存模型定义了共享内存系统中多线程读写内存操作的行为规范

### java内存模型

java内存模型是一种符合计算机内存模型规范的模型，为的是保证并发编程可以满足原子性，有序性，可见性

java内存模型规定了所有变量都存储在主存中，每个线程有自己的工作内存，用到的变量是主内存副本拷贝，线程对变量的所有操作都必须在工作内存中进行，不能直接写主存，不同线程之间无法直接访问对方工作内存中的变量

![](http://ww1.sinaimg.cn/large/87a42753ly1g3gz8y33ahj20jp08bq5b.jpg)

### java内存模型运行数据区

![](http://ww1.sinaimg.cn/large/87a42753ly1g3gz96d4k3j20ga0bbady.jpg)

程序计数器：当前线程所执行字节码的行号指示器，多线程通过轮流切换并分配处理器执行时间的方式来实现，每一个时刻，一个核心（单核，或者多核的其中一个核），只会执行一条线程指令，为了线程切换后能回到正确的执行位置，每个线程需要一个程序计数器

虚拟机栈：java方法执行的内存模型，每个方法被执行的时候都会创建一个栈帧用于存储局部变量，操作数栈，动态链接返回地址等信息，方法的调用到执行完成，对应一个栈帧在虚拟机栈中从入栈到出栈

### java并发关键字

java内存模型封装了底层的实现后提供给程序员使用一些和并发处理相关的关键字。如Volatile、Synchronized、Final、Concurrent 包等。





reference：https://www.jianshu.com/p/c15ab8664bee